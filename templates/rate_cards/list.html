{% extends 'base/base.html' %}
{% load static %}

{% block title %}Rate Cards - Excis Billing System{% endblock %}
{% block page_title %}Rate Cards{% endblock %}

{% block header_js %}
<script src="{% static 'js/rate_cards/lists.js' %}" type="script"></script>
{% endblock %}

{% block extra_css %}
<style>
    /* Fix dropdown visibility issues */
    .dropdown-menu {
        z-index: 1050 !important;
    }
    
    .table-responsive {
        overflow: visible !important;
    }
    .table-container { background: #fff; border-radius: 8px; padding: 0.01rem; box-shadow: 0 2px 8px rgba(0,0,0,0.05); overflow-x: scroll;}

    
    /* Ensure table doesn't clip dropdowns on smaller screens */
    @media (max-width: 768px) {
        .table-responsive {
            overflow-x: auto;
            overflow-y: visible;
        }
    }
    
    /* Fix dropdown positioning */
    .dropdown {
        position: static;
    }
    
    @media (min-width: 768px) {
        .dropdown {
            position: relative;
        }
    }
    /* .w-100.text-center.m-20:hover { */
    
    /* border-width: 2px;  */
    /* border-color: #ebebf9; */
    /* border-color: #3e3691; */
    /* box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15); */
/* } */
.nav>.nav-item{
    border-style: dashed;
    border-width: 10px;
    border-radius: 5px;
}
.cards>.active { 
    /* border-color: #ebebf9; */
    border-color: #3e3691;
    background: #ebebf9;
}

.w-100.text-center.m-20 {
	height: 50px;
    border-width: 1px;
	display: flex;
	justify-content: center;
	align-items: center;
    margin: 0px 20px;
    border-style: solid;
}

#cardsth:hover {
    cursor: pointer;
    border-width: 2px; 
/* border-color: #ebebf9; */
background: #ebebf9;
border-color: #3e3691;
}

</style>
{% endblock %}

{% block content %}
<div class="content-body default-height">
            <div class="container-fluid">
<style>
/* ---------- keep your original style variables ---------- */
:root{
  --bg:#fff;
  --text:#000;
  --muted:#555;
  --line:#ddd;
  --panel:#fafafa;
  --chip:#f3f4f6;
  --brand:#5335ff;
  --btn:#f5f5f5;
  --btn-h:#ececec;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
  color:var(--text); background:var(--bg);
}
.wrap{min-height:100%; display:flex; flex-direction:column}

/* top/title */
.titlebar{display:flex;align-items:center;gap:12px;padding:12px 16px;border-bottom:1px solid var(--line);background:var(--panel)}
.spacer{flex:1}
.btn{display:inline-flex;align-items:center;gap:8px;background:var(--btn);border:1px solid var(--line);color:var(--text);padding:8px 12px;border-radius:8px;cursor:pointer;font-weight:600}
.btn:hover{background:var(--btn-h)}
.btn.primary{background:#e9e7ff;border-color:#c3b8fe}

/* cards */
.cards{display:flex;gap:12px;padding:12px 16px;border-bottom:1px solid var(--line);background:#fafafa}
.card{flex:1;min-width:160px;padding:16px;text-align:center;border:2px solid #ddd;border-radius:10px;background:#fff;cursor:pointer;transition:.18s}
.card:hover{border-color:var(--brand)}
.card.active{border-color:var(--brand);background:#e9e7ff;font-weight:700}

/* filters */
.filters{display:flex;gap:8px;padding:12px 16px;border-bottom:1px solid var(--line);align-items:center;flex-wrap:wrap}
.rc-input{border:1px solid var(--line);padding:8px 10px;border-radius:8px;background:#fff}
.rc-select{border:1px solid var(--line);padding:8px 10px;border-radius:8px;background:#fff}

/* table */
.list{flex:1;overflow:auto;padding:12px}
table{width:100%;border-collapse:collapse;min-width:1100px}
thead th{position:sticky;top:0;z-index:1;text-align:left;padding:10px;background:#f3f3f3;color:#333;font-size:12px;font-weight:700;border-bottom:1px solid var(--line)}
tbody td{padding:10px;border-bottom:1px solid var(--line);vertical-align:middle}
tbody tr:hover{background:#fafafa}
.actions{display:flex;gap:6px}
.iconbtn{border:1px solid var(--line);background:#fff;border-radius:8px;padding:6px 8px;cursor:pointer;font-size:14px}
.iconbtn:hover{background:#eee}
.footer{padding:12px 16px;border-top:1px solid var(--line);background:var(--panel);}

/* dedicated / band headers */
thead tr.rc-band-group th{background:#102a43;color:#fff;text-align:center}
thead tr.rc-band-sub th{background:#243b53;color:#fff;text-align:center;font-weight:600}

/* modal (scoped) */
#rcModalBackdrop{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.6);z-index:9999}
#rcModalBackdrop.show{display:flex}
.rcModal{background:#fff;padding:18px;border-radius:10px;min-width:360px;max-width:900px;max-height:85vh;overflow:auto;box-shadow:0 12px 40px rgba(0,0,0,0.45)}
.rcModal h3{margin:0 0 10px 0}
.rcFormRow{display:flex;gap:8px;align-items:center;margin-bottom:8px}
.rcFormRow label{min-width:120px;font-weight:600}
.rcFormRow input, .rcFormRow select {flex:1;padding:8px;border:1px solid var(--line);border-radius:6px}
.rcModal .rcActions{display:flex;justify-content:flex-end;gap:8px;margin-top:12px}
.small{font-size:12px;color:var(--muted)}
</style>
</head>
<body>
<div class="wrap">

  <!-- cards -->
  <div class="cards" id="rcCards">
    <div class="card active" data-type="default">üìã Rate Cards</div>
    <div class="card" data-type="service-rate">üßæ Service Rate Card</div>
    <div class="card" data-type="dedicated">üßë‚Äçüíª Dedicated Services</div>
    <div class="card" data-type="scheduled">üìÖ Scheduled Services</div>
    <div class="card" data-type="dispatch">üöö Dispatch Services</div>
    <div class="card" data-type="projects">üèóÔ∏è Projects</div>
  </div>

  <!-- titlebar -->
  <div class="titlebar">
    <div class="sub small">Manage pricing by customer, region, and service type</div>
    <div class="spacer"></div>
    <button class="btn" id="rcNewBtn">Ôºã New Rate Card</button>
  </div>

  <!-- filters -->
  <div class="filters" id="rcFilters">
    <input id="rc_search" class="rc-input" placeholder="Search customer/ country..." />
    <select id="rc_region" class="rc-select"><option value="">All Regions</option><option>EMEA</option><option>APAC</option><option>NA</option></select>
    <select id="rc_currency" class="rc-select"><option value="">All Currencies</option><option>USD</option><option>EUR</option><option>GBP</option></select>
    <select id="rc_supplier" class="rc-select"><option value="">All Suppliers</option></select>
  </div>

  <!-- table container -->
  <div class="list" id="rcTableContainer"></div>

  
</div>

<!-- Modal (scoped unique IDs) -->
<div id="rcModalBackdrop" aria-hidden="true">
  <div class="rcModal" role="dialog" aria-modal="true" aria-labelledby="rcModalTitle">
    <h3 id="rcModalTitle">Rate Card</h3>
    <div id="rcModalBody"></div>
    <div class="rcActions">
      <button class="btn" id="rcCancelBtn">Cancel</button>
      <button class="btn primary" id="rcSaveBtn">Save</button>
    </div>
  </div>
</div>

<script>

(function RateCardApp(){
  const ns = {};
  
  ns.data = [
  { id: 1, customer:'HCL Technologies', region:'EMEA', country:'Germany', supplier:'Vendor A', currency:'EUR', entity:'E1', payment:'30 Days', status:'Active' },
  { id: 2, customer:'Cognizant', region:'APAC', country:'India', supplier:'Vendor B', currency:'USD', entity:'E2', payment:'45 Days', status:'Pending' },
  { id: 3, customer:'TCS', region:'NA', country:'USA', supplier:'Vendor C', currency:'USD', entity:'E3', payment:'30 Days', status:'Active' },

  // üÜï Lenovo Thailand (connected to rate_card sample)
  { id: 101, customer:'Lenovo Thailand', region:'APAC', country:'Thailand', supplier:'Vendor TH', currency:'THB', entity:'Lenovo Entity TH', payment:'30 Days', status:'Active' }
];

  ns.dedicatedCols = ['Band 0','Band 1','Band 2','Band 3','Band 4'];
  ns.scheduledGroups = [
    { title:'Full Day Visit (8hrs)', bands:['Band 0','Band 1','Band 2'] },
    { title:'1/2 Day Visit (4hrs)', bands:['Band 0','Band 1','Band 2'] }
  ];
  ns.dispatchGroups = [
    { title:'Dispatch Ticket (Incident)', bands:['4 hour','SBD','NBD','2 BD','3 BD','Additional Hour'] },
    { title:'Dispatch Ticket (IMAC)', bands:['2 BD','3 BD','4 BD'] }
  ];
  ns.projectGroups = [
    { title:'Short Term (Up to 3 months)', bands:['Band 0','Band 1','Band 2','Band 3','Band 4'] },
    { title:'Long Term (more than 3 months)', bands:['Band 0','Band 1','Band 2','Band 3','Band 4'] }
  ];
  ns.rateCardSample = {
  id: 101,
  account_name: "Lenovo Thailand",
  currency: "THB",
  valid_from: "2025-01-01",
  valid_to: null,
  contact_email: "finance.th@lenovo.com",
  last_updated_by: "billing_admin",
  last_updated_at: "2025-10-14T12:30:00Z",
  service_rates: [
    {
      category: "Dispatch",
      region: "Bangkok",
      rate_type: "hourly",
      rate_value: 850,
      after_hours_multiplier: 1.5,
      weekend_multiplier: 2.0,
      travel_charge: 0
    },
    {
      category: "FTE",
      region: "Thailand",
      rate_type: "monthly",
      rate_value: 60000,
      remarks: "Level 2 engineer full-time placement"
    },
    {
      category: "Scheduled Visit",
      region: "Thailand",
      rate_type: "day",
      rate_value: 3200,
      includes_travel: true
    }
  ]
};

  ns.services = {};
  function initServiceValues(){
    ns.data.forEach(rec=>{
      ns.services[rec.id] = {
        dedicated: ns.dedicatedCols.flatMap((b,i)=>[`$${26000+i*2000}`, `$${23000+i*1800}`]),
        scheduled: ns.scheduledGroups.flatMap(g=>g.bands.map((b,i)=>`$${300+i*20}`)),
        dispatch: ns.dispatchGroups.flatMap(g=>g.bands.map((b,i)=>`$${100+i*50}`)),
        projects: ns.projectGroups.flatMap(g=>g.bands.map((b,i)=>`$${5000+i*500}`))
      };
    });
  }
  initServiceValues();

  // DOM
  const container = document.getElementById('rcTableContainer');
  const cards = document.querySelectorAll('#rcCards .card');
  const modalBackdrop = document.getElementById('rcModalBackdrop');
  const modalTitle = document.getElementById('rcModalTitle');
  const modalBody = document.getElementById('rcModalBody');
  const saveBtn = document.getElementById('rcSaveBtn');
  const cancelBtn = document.getElementById('rcCancelBtn');
  const searchEl = document.getElementById('rc_search');
  const regionEl = document.getElementById('rc_region');
  const currencyEl = document.getElementById('rc_currency');
  const supplierEl = document.getElementById('rc_supplier');
  const newBtn = document.getElementById('rcNewBtn');
  ns.currentType='default';

  // Utils
  const esc = s=>String(s??'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));
  const uniqueSuppliers=()=>[...new Set(ns.data.map(d=>d.supplier))];
  function refreshSupplierFilter(){
    supplierEl.innerHTML='<option value="">All Suppliers</option>'+uniqueSuppliers().map(s=>`<option>${s}</option>`).join('');
  }
  function filterData(){
    const q=(searchEl.value||'').toLowerCase(),r=regionEl.value,c=currencyEl.value,s=supplierEl.value;
    return ns.data.filter(d=>
      (!r||d.region===r)&&(!c||d.currency===c)&&(!s||d.supplier===s)&&(!q||[d.customer,d.country,d.supplier].some(x=>x.toLowerCase().includes(q)))
    );
  }

  const baseCols=()=>`<th>#</th><th>Customer</th><th>Region</th><th>Country</th><th>Supplier</th><th>Currency</th><th>Entity</th><th>Payment</th>`;
  const baseCells=(r,i)=>`<td>${i+1}</td><td>${esc(r.customer)}</td><td>${esc(r.region)}</td><td>${esc(r.country)}</td><td>${esc(r.supplier)}</td><td>${esc(r.currency)}</td><td>${esc(r.entity)}</td><td>${esc(r.payment)}</td>`;

  // Renderers
  function renderDefault(){
    const rows=filterData().map((r,i)=>`
      <tr data-id="${r.id}">
        ${baseCells(r,i)}
        <td>${r.status}</td>
        <td class="actions">
          <button class="iconbtn rc-view" data-id="${r.id}">üëÅÔ∏è</button>
          <button class="iconbtn rc-edit" data-id="${r.id}">‚úèÔ∏è</button>
          <button class="iconbtn rc-del" data-id="${r.id}">üóëÔ∏è</button>
        </td>
      </tr>`).join('');
    container.innerHTML=`<table><thead><tr>${baseCols()}<th>Status</th><th>Actions</th></tr></thead><tbody>${rows}</tbody></table>`;
  }

  function renderGeneric(groups,key){
    const rows=filterData().map((r,i)=>{
      const svc=ns.services[r.id][key];
      const cells=svc.map(v=>`<td style="text-align:center">${esc(v)}</td>`).join('');
      return `<tr data-id="${r.id}">${baseCells(r,i)}${cells}<td>${r.status}</td>
      <td class="actions"><button class="iconbtn rc-view" data-id="${r.id}">üëÅÔ∏è</button><button class="iconbtn rc-edit" data-id="${r.id}">‚úèÔ∏è</button><button class="iconbtn rc-del" data-id="${r.id}">üóëÔ∏è</button></td></tr>`;
    }).join('');
    const ths=groups.map(g=>`<th colspan="${g.bands.length}" style="text-align:center">${g.title}</th>`).join('');
    const subs=groups.map(g=>g.bands.map(b=>`<th>${b}</th>`).join('')).join('');
    container.innerHTML=`<table><thead><tr>${baseCols()}${ths}<th>Status</th><th>Actions</th></tr><tr><th colspan="8"></th>${subs}<th colspan="2"></th></tr></thead><tbody>${rows}</tbody></table>`;
  }

  function renderDedicated(){
    const rows=filterData().map((r,i)=>{
      const svc=ns.services[r.id].dedicated;
      const cells=svc.map(v=>`<td style="text-align:center">${esc(v)}</td>`).join('');
      return `<tr data-id="${r.id}">${baseCells(r,i)}${cells}<td>${r.status}</td>
      <td class="actions"><button class="iconbtn rc-view" data-id="${r.id}">üëÅÔ∏è</button><button class="iconbtn rc-edit" data-id="${r.id}">‚úèÔ∏è</button><button class="iconbtn rc-del" data-id="${r.id}">üóëÔ∏è</button></td></tr>`;
    }).join('');
    const bands=ns.dedicatedCols.map(b=>`<th colspan="2">${b}</th>`).join('');
    const subs=ns.dedicatedCols.map(()=>`<th>With</th><th>Without</th>`).join('');
    container.innerHTML=`<table><thead><tr>${baseCols()}${bands}<th>Status</th><th>Actions</th></tr><tr><th colspan="8"></th>${subs}<th colspan="2"></th></tr></thead><tbody>${rows}</tbody></table>`;
  }

  function render(){ 
  if(ns.currentType==='dedicated') renderDedicated();
//   else if(ns.currentType==='scheduled') renderGeneric(ns.scheduledGroups,'scheduled');
//   else if(ns.currentType==='dispatch') renderGeneric(ns.dispatchGroups,'dispatch');
//   else if(ns.currentType==='projects') renderGeneric(ns.projectGroups,'projects');
  else if(ns.currentType==='service-rate') renderServiceRateCard();
  else renderDefault();
}



function renderServiceRateCard() {
  const rows=filterData().map((r,i)=>{
      const svc=ns.services[r.id].dedicated;
      const cells=svc.map(v=>`<td style="text-align:center">${esc(v)}</td>`).join('');
      return `<tr data-id="${r.id}">${baseCells(r,i)}${cells}<td>${r.status}</td>
      <td class="actions"><button class="iconbtn rc-view" data-id="${r.id}">üëÅÔ∏è</button><button class="iconbtn rc-edit" data-id="${r.id}">‚úèÔ∏è</button><button class="iconbtn rc-del" data-id="${r.id}">üóëÔ∏è</button></td></tr>`;
    }).join('');
    const bands=ns.dedicatedCols.map(b=>`<th colspan="2">${b}</th>`).join('');
    const subs=ns.dedicatedCols.map(()=>`<th>With</th><th>Without</th>`).join('');
    container.innerHTML=`<table><thead><tr>${baseCols()}${bands}<th>Status</th><th>Actions</th></tr><tr><th colspan="8"></th>${subs}<th colspan="2"></th></tr></thead><tbody>${rows}</tbody></table>`;

  // üì§ When "Standardize Rate Card" is clicked, show generated JSON
//   document.getElementById('standardizeBtn').onclick = () => {
//     const generated = {
//       id: d.id,
//       account_name: d.account_name,
//       currency: d.currency,
//       valid_from: d.valid_from,
//       valid_to: d.valid_to,
//       service_rates: d.service_rates,
//       contact_email: d.contact_email,
//       last_updated_by: d.last_updated_by,
//       last_updated_at: d.last_updated_at
//     };
//     modalTitle.textContent = "üì§ Standardized Rate Card JSON";
//     modalBody.innerHTML = `<pre style="background:#f5f5f5;padding:10px;border-radius:6px;white-space:pre-wrap;">${JSON.stringify(generated, null, 2)}</pre>`;
//     modalBackdrop.style.display = "flex";
//     saveBtn.onclick = () => (modalBackdrop.style.display = "none");
//   };
}




  // ---------- MODAL ----------
  function openModal(mode,id){
    const rec=id?ns.data.find(x=>x.id===id):{id:Date.now(),customer:'',region:'',country:'',supplier:'',currency:'USD',entity:'',payment:'',status:'Active'};
    const svcType=ns.currentType;
    modalTitle.textContent=mode==='edit'?'Edit Record':mode==='view'?'View Record':'New Rate Card';
    const readonly=mode==='view'?'readonly':'';
    let html=`
    <div class="rcFormRow"><label>Customer</label><input id="rcf_customer" value="${esc(rec.customer)}" ${readonly}></div>
    <div class="rcFormRow"><label>Region</label><input id="rcf_region" value="${esc(rec.region)}" ${readonly}></div>
    <div class="rcFormRow"><label>Country</label><input id="rcf_country" value="${esc(rec.country)}" ${readonly}></div>
    <div class="rcFormRow"><label>Supplier</label><input id="rcf_supplier" value="${esc(rec.supplier)}" ${readonly}></div>
    <div class="rcFormRow"><label>Currency</label><input id="rcf_currency" value="${esc(rec.currency)}" ${readonly}></div>
    <div class="rcFormRow"><label>Entity</label><input id="rcf_entity" value="${esc(rec.entity)}" ${readonly}></div>
    <div class="rcFormRow"><label>Payment</label><input id="rcf_payment" value="${esc(rec.payment)}" ${readonly}></div>
    <div class="rcFormRow"><label>Status</label><input id="rcf_status" value="${esc(rec.status)}" ${readonly}></div>`;

    if(svcType!=='default'){
      html+=`<div style="font-weight:700;margin:10px 0;">${svcType.toUpperCase()} VALUES</div>`;
      const svc=ns.services[rec.id]||{};
      let i=0;
      if(svcType==='dedicated'){
        ns.dedicatedCols.forEach(b=>{
          html+=`<div class="rcFormRow"><label>${b} (With)</label><input id="rcf_ded_${i}" value="${esc(svc.dedicated?.[i]||'')}" ${readonly}></div>`;
          i++;
          html+=`<div class="rcFormRow"><label>${b} (Without)</label><input id="rcf_ded_${i}" value="${esc(svc.dedicated?.[i]||'')}" ${readonly}></div>`;
          i++;
        });
      } else {
        const groups=(svcType==='scheduled')?ns.scheduledGroups:(svcType==='dispatch')?ns.dispatchGroups:ns.projectGroups;
        groups.forEach(g=>g.bands.forEach(b=>{
          html+=`<div class="rcFormRow"><label>${g.title} - ${b}</label><input id="rcf_svc_${i}" value="${esc(svc[svcType]?.[i]||'')}" ${readonly}></div>`;
          i++;
        }));
      }
    }
    modalBody.innerHTML=html;
    modalBackdrop.style.display='flex';

    // Save handler (edit/new)
    saveBtn.onclick=()=>{
      if(mode==='view'){modalBackdrop.style.display='none';return;}
      rec.customer=document.getElementById('rcf_customer').value;
      rec.region=document.getElementById('rcf_region').value;
      rec.country=document.getElementById('rcf_country').value;
      rec.supplier=document.getElementById('rcf_supplier').value;
      rec.currency=document.getElementById('rcf_currency').value;
      rec.entity=document.getElementById('rcf_entity').value;
      rec.payment=document.getElementById('rcf_payment').value;
      rec.status=document.getElementById('rcf_status').value;
      if(!id) ns.data.push(rec);

      if(svcType!=='default'){
        const svc=ns.services[rec.id]||{};
        if(svcType==='dedicated'){
          svc.dedicated=[];
          for(let i=0;i<ns.dedicatedCols.length*2;i++){
            svc.dedicated[i]=document.getElementById(`rcf_ded_${i}`).value;
          }
        } else {
          const groups=(svcType==='scheduled')?ns.scheduledGroups:(svcType==='dispatch')?ns.dispatchGroups:ns.projectGroups;
          svc[svcType]=[];
          let i=0;groups.forEach(g=>g.bands.forEach(()=>{
            svc[svcType][i]=document.getElementById(`rcf_svc_${i}`).value;
            i++;
          }));
        }
        ns.services[rec.id]=svc;
      }
      modalBackdrop.style.display='none';
      refreshSupplierFilter();
      render();
    };
    cancelBtn.onclick=()=>modalBackdrop.style.display='none';
  }

  function deleteRec(id){
    if(!confirm('Delete this record?'))return;
    ns.data=ns.data.filter(x=>x.id!==id);
    delete ns.services[id];
    render();
  }

  // Events
  container.addEventListener('click', e => {
  const id = +e.target.dataset.id;
  const viewType = e.target.dataset.viewtype;

  if (e.target.classList.contains('rc-view')) {
    if (viewType === 'details') {
      const d = ns.rateCardSample;
      modalTitle.textContent = "Service Rate Card Details";
      modalBody.innerHTML = `
        <div><b>${d.account_name}</b></div>
        <div>Currency: ${d.currency}</div>
        <div>Valid From: ${d.valid_from}</div>
        <div>Valid To: ${d.valid_to ?? '‚Äî'}</div>
        <div>Contact Email: ${d.contact_email}</div>
        <div>Last Updated By: ${d.last_updated_by}</div>
        <div>Last Updated At: ${new Date(d.last_updated_at).toLocaleString()}</div>
      `;
      modalBackdrop.style.display = 'flex';
      saveBtn.onclick = () => (modalBackdrop.style.display = 'none');
    } else {
      openModal('view', id);
    }
  }

  if (e.target.classList.contains('rc-edit')) openModal('edit', id);
  if (e.target.classList.contains('rc-del')) deleteRec(id);
});

  cards.forEach(c=>c.onclick=()=>{cards.forEach(x=>x.classList.remove('active'));c.classList.add('active');ns.currentType=c.dataset.type;render();});
  [searchEl,regionEl,currencyEl,supplierEl].forEach(el=>el.oninput=render);
  newBtn.onclick=()=>openModal('new');

  refreshSupplierFilter();
  render();
})();
</script>





            </div>
        </div>
{% endblock %}
