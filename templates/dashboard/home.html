{% extends 'base/base.html' %}
{% load static %}

{% block title %}Dashboard - Excis Billing System{% endblock %}

{% block extra_css %}
    <!-- No conflicting styles -->
{% endblock %}

{% block content %}
        <div class="row">
            <div class="col-lg-3 col-sm-6">
                <div class="card">
                    <div class="card-body">
                        <h4 class="card-title">Total Customers</h4>
                        <h2 class="text-primary">{{ kpis.total_customers }}</h2>
                        <p class="text-muted">Active accounts</p>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-sm-6">
                <div class="card">
                    <div class="card-body">
                        <h4 class="card-title">Active POs</h4>
                        <h2 class="text-primary">{{ kpis.active_pos }}</h2>
                        <p class="text-muted">Purchase orders</p>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-sm-6">
                <div class="card">
                    <div class="card-body">
                        <h4 class="card-title">Pending Approvals</h4>
                        <h2 class="text-primary">{{ kpis.pending_approvals }}</h2>
                        <p class="text-muted">Need attention</p>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-sm-6">
                <div class="card">
                    <div class="card-body">
                        <h4 class="card-title">Total Revenue</h4>
                        <h2 class="text-primary">${{ kpis.total_revenue|floatformat:0 }}</h2>
                        <p class="text-muted">Last 30 days</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h4 class="card-title">Recent Billing Files</h4>
                        <a href="#" class="btn btn-primary">View All</a>
                    </div>
                    <div class="card-body">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>RUN ID</th>
                                    <th>CUSTOMER</th>
                                    <th>PO NUMBER</th>
                                    <th>AMOUNT</th>
                                    <th>DATE</th>
                                    <th>STATUS</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for billing in recent_billing %}
                                <tr>
                                    <td>{{ billing.run_id }}</td>
                                    <td>{{ billing.customer.name }}</td>
                                    <td>{{ billing.purchase_order.po_number }}</td>
                                    <td>${{ billing.amount|floatformat:2 }}</td>
                                    <td>{{ billing.billing_date }}</td>
                                    <td>{{ billing.get_status_display }}</td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="6">No billing runs found</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h4 class="card-title">Quick Actions</h4>
                    </div>
                    <div class="card-body">
                        <a href="{% url 'billing:create' %}" class="btn btn-primary">Create Billing Run </a>
                        <a href="{% url 'purchase_orders:create' %}" class="btn btn-primary">Add Purchase Order </a>
                        <a href="{% url 'customers:create' %}" class="btn btn-primary">Add Customer </a>
                        <a href="{% url 'rate_cards:create' %}" class="btn btn-primary">Create Rate Card </a>
                    </div>
                </div>
            </div>
        </div>

        {% if kpis.low_balance_pos > 0 or kpis.pending_approvals > 0 %}
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h4 class="card-title">Alerts & Notifications</h4>
                    </div>
                    <div class="card-body">
                        {% if kpis.low_balance_pos > 0 %}
                        <div class="alert alert-warning">
                            {{ kpis.low_balance_pos }} POs below 20% balance
                            <p>Action required to avoid billing delays</p>
                        </div>
                        {% endif %}
                        {% if kpis.pending_approvals > 0 %}
                        <div class="alert alert-warning">
                            {{ kpis.pending_approvals }} files pending approval
                            <p>Review required</p>
                        </div>
                        {% endif %}
                        {% if kpis.draft_pos > 0 %}
                        <div class="alert alert-warning">
                            {{ kpis.draft_pos }} draft POs
                            <p>Need to be activated</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h4 class="card-title">Recent Purchase Orders</h4>
                        <a href="#" class="btn btn-primary">View All</a>
                    </div>
                    <div class="card-body">
                        {% for po in recent_pos %}
                        <div class="d-flex justify-content-between">
                            <div>
                                <h5>{{ po.po_number }}</h5>
                                <p>{{ po.customer.name }}</p>
                            </div>
                            <div>
                                <h5>${{ po.total_amount|floatformat:0 }}</h5>
                                <p>{{ po.status|title }}</p>
                            </div>
                        </div>
                        {% empty %}
                        <p>No purchase orders found</p>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

{% endblock %}

{% block extra_js %}
    <!-- No conflicting scripts -->
{% endblock %}