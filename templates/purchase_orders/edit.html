{% extends 'base/base.html' %}
{% load static %}

{% block title %}Edit Purchase Order {{ purchase_order.po_number }} - Excis Billing System{% endblock %}

{% block extra_css %}
<style>
  .form-section {
    background: white;
    border-radius: 0.5rem;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    padding: 1.5rem;
    margin-bottom: 1rem;
  }

  .currency-input {
    position: relative;
  }

  .currency-symbol {
    position: absolute;
    left: 12px;
    top: 50%;
    transform: translateY(-50%);
    color: #6b7280;
    font-weight: 500;
    z-index: 10;
  }

  .currency-input input {
    padding-left: 35px;
  }

  .utilization-info {
    background: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    padding: 15px;
    margin-top: 15px;
  }

  .progress {
    height: 10px;
    border-radius: 5px;
    background-color: #e9ecef;
    overflow: hidden;
  }

  .progress-bar {
    height: 100%;
    transition: width 0.3s ease;
  }

  .alert-warning {
    background-color: #fff3cd;
    border-color: #ffeaa7;
    color: #856404;
  }

  .alert-danger {
    background-color: #f8d7da;
    border-color: #f5c6cb;
    color: #721c24;
  }

  .alert-success {
    background-color: #d1f2eb;
    border-color: #c3e6cb;
    color: #155724;
  }
</style>
{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto p-4 sm:p-6 lg:p-8">
  <!-- Header -->
  <div class="flex justify-between items-center mb-6">
    <div>
      <h1 class="text-2xl font-bold text-gray-900">Edit Purchase Order {{ purchase_order.po_number }}</h1>
      <p class="text-gray-600">Update details for {{ purchase_order.get_customer_account_display }}</p>
    </div>
    <a href="{% url 'purchase_orders:detail' purchase_order.pk %}" class="inline-flex items-center px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">
      Back to Details
    </a>
  </div>

  <!-- Form -->
  <form method="POST" class="form-section" id="editPOForm">
    {% csrf_token %}
    
    <!-- Customer Information -->
    <div class="mb-6">
      <h2 class="text-lg font-semibold text-gray-900 mb-4">Customer Information</h2>
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-medium text-gray-700">Customer</label>
          {{ form.customer }}
          {% if form.customer.help_text %}
          <p class="mt-1 text-sm text-gray-500">{{ form.customer.help_text }}</p>
          {% endif %}
          {% if form.customer.errors %}
          <p class="mt-1 text-sm text-red-600">{{ form.customer.errors.0 }}</p>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Purchase Order Details -->
    <div class="mb-6">
      <h2 class="text-lg font-semibold text-gray-900 mb-4">Purchase Order Details</h2>
      <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
        <div>
          <label class="block text-sm font-medium text-gray-700">PO Number</label>
          {{ form.po_number }}
          {% if form.po_number.help_text %}
          <p class="mt-1 text-sm text-gray-500">{{ form.po_number.help_text }}</p>
          {% endif %}
          {% if form.po_number.errors %}
          <p class="mt-1 text-sm text-red-600">{{ form.po_number.errors.0 }}</p>
          {% endif %}
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">Currency</label>
          {{ form.currency }}
          {% if form.currency.help_text %}
          <p class="mt-1 text-sm text-gray-500">{{ form.currency.help_text }}</p>
          {% endif %}
          {% if form.currency.errors %}
          <p class="mt-1 text-sm text-red-600">{{ form.currency.errors.0 }}</p>
          {% endif %}
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">Reference Number</label>
          {{ form.reference_number }}
          {% if form.reference_number.help_text %}
          <p class="mt-1 text-sm text-gray-500">{{ form.reference_number.help_text }}</p>
          {% endif %}
          {% if form.reference_number.errors %}
          <p class="mt-1 text-sm text-red-600">{{ form.reference_number.errors.0 }}</p>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Financial Details -->
    <div class="mb-6">
      <h2 class="text-lg font-semibold text-gray-900 mb-4">Financial Details</h2>
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-medium text-gray-700">Total Amount</label>
          <div class="currency-input">
            <span class="currency-symbol" id="currencySymbol">$</span>
            {{ form.total_amount }}
          </div>
          {% if form.total_amount.help_text %}
          <p class="mt-1 text-sm text-gray-500">{{ form.total_amount.help_text }}</p>
          {% endif %}
          {% if form.total_amount.errors %}
          <p class="mt-1 text-sm text-red-600">{{ form.total_amount.errors.0 }}</p>
          {% endif %}
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">Current Balance (Remaining)</label>
          <div class="currency-input">
            <span class="currency-symbol" id="currencySymbolBalance">$</span>
            {{ form.balance }}
          </div>
          {% if form.balance.help_text %}
          <p class="mt-1 text-sm text-gray-500">{{ form.balance.help_text }}</p>
          {% endif %}
          {% if form.balance.errors %}
          <p class="mt-1 text-sm text-red-600">{{ form.balance.errors.0 }}</p>
          {% endif %}
          <p class="mt-1 text-xs text-gray-500">Amount available for future billing</p>
        </div>
      </div>

      <!-- Utilization Information -->
      <div class="utilization-info">
        <div class="flex justify-between items-center mb-2">
          <span class="text-sm font-medium text-gray-700">PO Utilization</span>
          <span class="text-sm text-gray-600" id="utilizationPercent">{{ purchase_order.utilization_percentage|floatformat:1 }}%</span>
        </div>
        <div class="progress mb-2">
          <div class="progress-bar bg-blue-500" id="utilizationBar" style="width: {{ purchase_order.utilization_percentage }}%"></div>
        </div>
        <div class="grid grid-cols-3 gap-4 text-sm">
          
          <div>
            <span class="text-gray-500">Remaining:</span>
            <span class="font-medium" id="remainingAmount">{{ purchase_order.formatted_balance }}</span>
          </div>
          <div>
            <span class="text-gray-500">Total:</span>
            <span class="font-medium" id="totalAmountDisplay">{{ purchase_order.formatted_amount }}</span>
          </div>
        </div>

        <!-- Balance Status Alert -->
        <div class="mt-3" id="balanceAlert">
          {% if purchase_order.utilization_percentage >= 90 %}
            <div class="alert alert-danger">
              <strong>Critical:</strong> PO balance is critically low ({{ purchase_order.utilization_percentage|floatformat:1 }}% used)
            </div>
          {% elif purchase_order.utilization_percentage >= 80 %}
            <div class="alert alert-warning">
              <strong>WarniAdminng:</strong> PO balance is running low ({{ purchase_order.utilization_percentage|floatformat:1 }}% used)
            </div>
          {% else %}
            <div class="alert alert-success">
              <strong>Good:</strong> PO has adequate balance remaining
            </div>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Validity Period -->
    <div class="mb-6">
      <h2 class="text-lg font-semibold text-gray-900 mb-4">Validity Period</h2>
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-medium text-gray-700">Valid From</label>
          {{ form.valid_from }}
          {% if form.valid_from.errors %}
          <p class="mt-1 text-sm text-red-600">{{ form.valid_from.errors.0 }}</p>
          {% endif %}
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">Valid Until</label>
          {{ form.valid_until }}
          {% if form.valid_until.errors %}
          <p class="mt-1 text-sm text-red-600">{{ form.valid_until.errors.0 }}</p>
          {% endif %}
        </div>
      </div>
      <div class="mt-2">
        <p class="text-sm text-gray-500">
          Duration: 
          {% if purchase_order.valid_from and purchase_order.valid_until %}
            <span id="durationDisplay">{{ purchase_order.days_until_expiry }} days</span>
            {% if purchase_order.is_expiring_soon %}
              <span class="text-amber-600 font-medium">(Expiring Soon)</span>
            {% elif purchase_order.is_expired %}
              <span class="text-red-600 font-medium">(Expired)</span>
            {% endif %}
          {% else %}
            Please select both dates
          {% endif %}
        </p>
      </div>
    </div>

    <!-- Additional Information -->
    <div class="mb-6">
      <h2 class="text-lg font-semibold text-gray-900 mb-4">Additional Information</h2>
      <div>
        <label class="block text-sm font-medium text-gray-700">Notes</label>
        {{ form.notes }}
        <p class="mt-1 text-sm text-gray-500">Optional notes about this purchase order</p>
        {% if form.notes.errors %}
        <p class="mt-1 text-sm text-red-600">{{ form.notes.errors.0 }}</p>
        {% endif %}
      </div>
    </div>

    <!-- Form Actions -->
    <div class="flex justify-end space-x-3">
      <a href="{% url 'purchase_orders:list' %}" class="inline-flex items-center px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">
        Cancel
      </a>
      <button type="submit" class="inline-flex items-center px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
        Save Changes
      </button>
    </div>
  </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Currency symbol mapping
    const currencySymbols = {
        'USD': '$',
        'EUR': '€',
        'GBP': '£',
        'CAD': 'C$',
        'AUD': 'A$',
        'INR': '₹',
        'JPY': '¥'
    };

    // Get form elements
    const customerSelect = document.querySelector('#id_customer');
    const accountSelect = document.querySelector('#id_account');
    const currencySelect = document.querySelector('#id_currency');
    const totalAmountField = document.querySelector('#id_total_amount');
    const balanceField = document.querySelector('#id_balance');

    // Update currency symbols when currency changes
    if (currencySelect) {
        function updateCurrencySymbols() {
            const symbol = currencySymbols[currencySelect.value] || '$';
            const currencySymbolEl = document.getElementById('currencySymbol');
            const currencySymbolBalanceEl = document.getElementById('currencySymbolBalance');
            
            if (currencySymbolEl) currencySymbolEl.textContent = symbol;
            if (currencySymbolBalanceEl) currencySymbolBalanceEl.textContent = symbol;
        }

        currencySelect.addEventListener('change', updateCurrencySymbols);
        // Set initial symbols
        updateCurrencySymbols();
    }

    // Real-time utilization calculation
    function updateUtilization() {
        const totalAmount = parseFloat(totalAmountField.value) || 0;
        const balance = parseFloat(balanceField.value) || 0;
        const usedAmount = totalAmount - balance;
        const utilizationPercent = totalAmount > 0 ? (usedAmount / totalAmount * 100) : 0;

        // Update displays
        const utilizationPercentEl = document.getElementById('utilizationPercent');
        const utilizationBarEl = document.getElementById('utilizationBar');
        const usedAmountEl = document.getElementById('usedAmount');
        const remainingAmountEl = document.getElementById('remainingAmount');
        const totalAmountDisplayEl = document.getElementById('totalAmountDisplay');
        const balanceAlertEl = document.getElementById('balanceAlert');

        if (utilizationPercentEl) {
            utilizationPercentEl.textContent = utilizationPercent.toFixed(1) + '%';
        }

        if (utilizationBarEl) {
            utilizationBarEl.style.width = Math.min(utilizationPercent, 100) + '%';
            
            // Update color based on utilization
            utilizationBarEl.className = 'progress-bar';
            if (utilizationPercent >= 90) {
                utilizationBarEl.classList.add('bg-red-500');
            } else if (utilizationPercent >= 80) {
                utilizationBarEl.classList.add('bg-yellow-500');
            } else {
                utilizationBarEl.classList.add('bg-blue-500');
            }
        }

        const currency = currencySelect ? currencySelect.value : 'USD';
        const symbol = currencySymbols[currency] || '$';

        if (usedAmountEl) {
            usedAmountEl.textContent = `${symbol}${usedAmount.toFixed(2)}`;
        }

        if (remainingAmountEl) {
            remainingAmountEl.textContent = `${symbol}${balance.toFixed(2)}`;
        }

        if (totalAmountDisplayEl) {
            totalAmountDisplayEl.textContent = `${symbol}${totalAmount.toFixed(2)}`;
        }

        // Update balance alert
        if (balanceAlertEl) {
            let alertClass, alertContent;
            
            if (utilizationPercent >= 90) {
                alertClass = 'alert alert-danger';
                alertContent = `<strong>Critical:</strong> PO balance is critically low (${utilizationPercent.toFixed(1)}% used)`;
            } else if (utilizationPercent >= 80) {
                alertClass = 'alert alert-warning';
                alertContent = `<strong>Warning:</strong> PO balance is running low (${utilizationPercent.toFixed(1)}% used)`;
            } else {
                alertClass = 'alert alert-success';
                alertContent = '<strong>Good:</strong> PO has adequate balance remaining';
            }
            
            balanceAlertEl.className = alertClass;
            balanceAlertEl.innerHTML = alertContent;
        }
    }

    // Attach event listeners for real-time updates
    if (totalAmountField) {
        totalAmountField.addEventListener('input', updateUtilization);
    }
    if (balanceField) {
        balanceField.addEventListener('input', updateUtilization);
    }
    if (currencySelect) {
        currencySelect.addEventListener('change', updateUtilization);
    }

    // Dynamic account dropdown population based on customer selection
    if (customerSelect && accountSelect) {
        customerSelect.addEventListener('change', function() {
            const customerId = this.value;
            
            if (customerId) {
                fetch(`/purchase-orders/api/customers/${customerId}/accounts/`)
                    .then(response => response.json())
                    .then(data => {
                        accountSelect.innerHTML = '<option value="">No specific account</option>';
                        if (data.success && data.accounts) {
                            data.accounts.forEach(account => {
                                const option = document.createElement('option');
                                option.value = account.id;
                                option.text = `${account.account_id} - ${account.name}`;
                                accountSelect.appendChild(option);
                            });
                        }
                    })
                    .catch(error => console.error('Error fetching accounts:', error));
            } else {
                accountSelect.innerHTML = '<option value="">Select customer first</option>';
            }
        });
    }

    // Form validation
    const form = document.getElementById('editPOForm');
    if (form) {
        form.addEventListener('submit', function(e) {
            const totalAmount = parseFloat(totalAmountField.value) || 0;
            const balance = parseFloat(balanceField.value) || 0;
            
            if (balance > totalAmount) {
                e.preventDefault();
                alert('Current balance cannot be greater than total amount');
                return false;
            }
            
            if (balance < 0) {
                e.preventDefault();
                alert('Current balance cannot be negative');
                return false;
            }
        });
    }

    // Initial calculation
    updateUtilization();
});
</script>
{% endblock %}