{% extends 'base/base.html' %}
{% load static %}

{% block title %}Customers & Accounts - Excis Billing System{% endblock %}

{% block page_title %}Customers & Accounts{% endblock %}

{% block extra_css %}
<style>
:root{
  --bg: #ffffff;
  --panel: #f9f9f9;
  --muted: #555;
  --muted-2:#666;
  --text:#000000;
  --line:#ddd;
  --brand:#5335ff;
  --btn:#f5f5f5;
  --btn-h:#ececec;
  --chip:#f2f2f2;
  --good:#e8f9ef;
  --warn:#fff5e6;
  --bad:#fdeaea;
  --link:#5335ff;
}

.customer-app{
  display:grid;
  grid-template-columns: 260px 1fr;
  height:calc(100vh - 200px);
  background: white;
  border-radius: 8px;
  overflow: hidden;
  box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

/* SIDEBAR */
.sidebar{
  border-right:1px solid var(--line);
  background:#fafafa;
  padding:16px;
  overflow:auto;
}
.sb-title{
  font-weight:600; 
  margin:0 0 12px 4px; 
  color:var(--text);
  font-size: 16px;
}
.sb-search{position:relative; margin:0 0 16px}
.sb-search input{
  width:100%; background:#fff; color:var(--text); border:1px solid var(--line);
  padding:12px 12px 12px 36px; border-radius:8px; outline:none;
  font-size: 14px;
}
.sb-search svg{position:absolute; left:10px; top:12px; opacity:.6}
.brand-list{display:flex; flex-direction:column; gap:8px; margin-top:8px}
.brand{
  display:flex; align-items:center; gap:12px;
  padding:12px; border-radius:10px; cursor:pointer;
  border:1px solid transparent;
  transition: all 0.2s ease;
}
.brand:hover{background:#f2f2f2}
.brand.active{background:#e6e6ff; border-color:#c3b8fe}
.dot{width:8px; height:8px; background:var(--brand); border-radius:50%;}
.brand-name{font-weight: 500; color: var(--text);}
.count{
  margin-left:auto; color:var(--muted); background:#fff; 
  border:1px solid var(--line); padding:4px 10px; 
  border-radius:20px; font-size:12px; font-weight: 500;
}

/* MAIN */
.main{display:flex; flex-direction:column; height:100%; overflow:hidden}
.topbar{
  display:flex; align-items:center; gap:12px; padding:16px 20px;
  border-bottom:1px solid var(--line); background:#f9f9f9;
}
.title-wrap{display:flex; flex-direction:column}
.main-title{font-weight:600; font-size: 18px; color: var(--text);}
.subtitle{color:var(--muted); font-size:13px; margin-top: 2px;}

.controls{display:flex; align-items:center; gap:10px; margin-left:auto;}
.btn{
  display:inline-flex; align-items:center; gap:8px;
  background:var(--btn); color:var(--text); border:1px solid var(--line);
  padding:10px 14px; border-radius:8px; cursor:pointer; font-weight:500;
  text-decoration: none; font-size: 14px;
  transition: all 0.2s ease;
}
.btn:hover{background:var(--btn-h); color: var(--text);}
.btn.primary{background:#5335ff; border-color:#5335ff; color: white;}
.btn.primary:hover{background:#4528e0; color: white;}
.icon{width:16px; height:16px;}

.filters{
  display:flex; gap:12px; padding:16px 20px; 
  border-bottom:1px solid var(--line); background:#fff; 
  flex-wrap:wrap; align-items: center;
}
.input, select{
  background:#fff; color:var(--text); border:1px solid var(--line); 
  border-radius:8px; padding:12px 14px; outline:none; font-size: 14px;
}
.search-wrapper{
  min-width:300px; display:flex; align-items:center; gap:10px;
  background:#fff; border:1px solid var(--line); border-radius:8px; padding:12px 14px;
}
.search-wrapper input{
  flex:1; background:transparent; border:none; outline:none; 
  color:var(--text); font-size: 14px;
}
.pill{
  font-size:12px; color:var(--muted); background:#fafafa; border:1px solid var(--line);
  padding:8px 12px; border-radius:8px; font-weight: 500;
}

/* TABLE */
.table-wrap{overflow:auto; flex:1; background: white;}
table{width:100%; border-collapse:collapse; min-width:1200px}
thead th{
  position:sticky; top:0; z-index:2;
  text-align:left; font-size:11px; color:var(--muted); font-weight:700;
  background:#f8f9fa; border-bottom:2px solid var(--line); 
  padding:16px 12px; text-transform: uppercase; letter-spacing: 0.5px;
}
tbody td{
  border-bottom:1px solid #f0f0f0; padding:16px 12px; vertical-align:middle;
}
tbody tr{transition: background-color 0.2s ease;}
tbody tr:hover{background:#f9f9f9}
.row-main{font-weight:500; color: var(--text); font-size: 14px;}
.row-sub{font-size:12px; color:var(--muted); margin-top: 2px;}
.mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size: 13px;}

.chip{
  display:inline-flex; align-items:center; gap:6px;
  padding:6px 10px; border-radius:999px; font-size:12px; 
  background:var(--chip); border:1px solid #ddd; font-weight: 500;
}
.chip.good{background:var(--good); color:#0c4021; border-color: #c3e6cb;}
.chip.bad{background:var(--bad); color:#8b1c2e; border-color: #f5c6cb;}
.chip.warn{background:var(--warn); color:#754c12; border-color: #ffeaa7;}

.status{
  font-size:11px; padding:6px 10px; border-radius:999px; 
  border:1px solid #ddd; background:#f8f9fa; color:#495057; 
  font-weight: 600; text-transform: uppercase; letter-spacing: 0.3px;
}
.status.active{background:#d4edda; color:#155724; border-color: #c3e6cb;}
.status.low{background:#f8d7da; color:#721c24; border-color: #f5c6cb;}
.status.missing{background:#fff3cd; color:#856404; border-color: #ffeaa7;}
.status.inactive{background:#e2e3e5; color:#495057; border-color: #d1d3d4;}

.actions{display:flex; gap:8px;}
.actions button, .actions a{
  background:#fff; border:1px solid var(--line); color:var(--text); 
  border-radius:6px; padding:8px 10px; cursor:pointer;
  text-decoration: none; display: inline-flex; align-items: center;
  font-size: 13px; transition: all 0.2s ease;
}
.actions button:hover, .actions a:hover{background:#f2f2f2; color: var(--text);}

.footer{
  display:flex; align-items:center; justify-content:space-between;
  padding:16px 20px; border-top:1px solid var(--line); background:#f9f9f9;
  font-size:13px; color:var(--muted);
}

.pagination{display:flex; gap:6px; align-items:center}
.pagination button{
  background:#fff; border:1px solid var(--line); color:var(--text);
  padding:8px 12px; border-radius:6px; cursor:pointer; font-size: 13px;
  transition: all 0.2s ease;
}
.pagination button:hover:not(:disabled){background:#f2f2f2}
.pagination button:disabled{opacity: 0.5; cursor: not-allowed;}
.pagination .current{background:#5335ff; border-color:#5335ff; color: white;}

.empty-state{
  text-align: center; padding: 60px 20px; color: var(--muted);
}
.empty-state h3{margin-bottom: 8px; color: var(--text);}

/* Responsive */
@media (max-width: 1100px){
  .customer-app{grid-template-columns: 220px 1fr;}
  .search-wrapper{min-width:220px}
  .hide-sm{display:none}
}
</style>
{% endblock %}

{% block content %}
<div class="customer-app">
  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="sb-title">Customers</div>
    <div class="sb-search">
      <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
        <path d="M10 2a8 8 0 1 1 5.3 14l4.4 4.4-1.4 1.4L13.9 17A8 8 0 0 1 10 2m0 2a6 6 0 1 0 0 12a6 6 0 0 0 0-12"/>
      </svg>
      <input type="text" id="customerSearch" placeholder="Search customers..." />
    </div>

    <div class="brand-list" id="customerList">
      {% for customer in customers %}
      <div class="brand {% if forloop.first %}active{% endif %}" 
           data-customer-id="{{ customer.id }}"
           data-customer-name="{{ customer.name }}">
        <span class="dot"></span>
        <span class="brand-name">{{ customer.name }}</span>
        <span class="count">{{ customer.accounts.all.count }}</span>
      </div>
      {% empty %}
      <div class="text-center text-muted py-3">
        <p>No customers found</p>
        <a href="{% url 'customers:create' %}" class="btn btn-sm btn-primary">Add Customer</a>
      </div>
      {% endfor %}
    </div>
  </aside>

  <!-- MAIN -->
  <main class="main">
    <div class="topbar">
      <div class="title-wrap">
        <div class="main-title" id="currentCustomerTitle">
          {% if customers %}{{ customers.0.name }} ‚Äî End Customer Accounts{% else %}Customer Accounts{% endif %}
        </div>
        <div class="subtitle">Manage billing cycles, rate cards, and PO assignments</div>
      </div>

      <div class="controls">
        <a href="{% url 'customers:create_account' %}" class="btn primary">
          <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
            <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
          </svg>
          Add Account
        </a>
        <a href="{% url 'customers:create' %}" class="btn">
          <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
            <path d="M15 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm-9-2V8c0-.55-.45-1-1-1s-1 .45-1 1v2H2c-.55 0-1 .45-1 1s.45 1 1 1h2v2c0 .55.45 1 1 1s1-.45 1-1v-2h2c.55 0 1-.45 1-1s-.45-1-1-1H6z"/>
          </svg>
          Add Customer
        </a>
        <button class="btn" id="btnRefresh">
          <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 6V3l4 4l-4 4V8A4 4 0 1 0 16 12h2A6 6 0 1 1 12 6z"/>
          </svg>
          Refresh
        </button>
      </div>
    </div>

    <div class="filters">
      <div class="search-wrapper">
        <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
          <path d="M10 2a8 8 0 1 1 5.3 14l4.4 4.4-1.4 1.4L13.9 17A8 8 0 0 1 10 2m0 2a6 6 0 1 0 0 12a6 6 0 0 0 0-12"/>
        </svg>
        <input id="accountSearch" placeholder="Search accounts..." />
      </div>

      <select id="statusFilter" class="input">
        <option value="">All Statuses</option>
        <option value="active">Active</option>
        <option value="inactive">Inactive</option>
        <option value="missing_po">Missing PO</option>
        <option value="low_po_balance">Low PO Balance</option>
      </select>

      <select id="cycleFilter" class="input">
        <option value="">All Billing Cycles</option>
        {% for cycle in billing_cycles %}
        <option value="{{ cycle.id }}">{{ cycle.name }}</option>
        {% endfor %}
      </select>

      <div class="pill hide-sm">
        Showing <span id="rangeInfo">0‚Äî0</span> of <span id="totalInfo">0</span> accounts
      </div>
    </div>

    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th style="width:30px;">
              <input type="checkbox" id="selectAll">
            </th>
            <th>Account Name</th>
            <th>Account ID</th>
            <th>Billing Cycle</th>
            <th>Currency</th>
            <th>Active PO</th>
            <th>PO Balance</th>
            <th>Last Billing</th>
            <th>Status</th>
            <th style="width:120px;">Actions</th>
          </tr>
        </thead>
        <tbody id="accountsTableBody">
          <tr>
            <td colspan="10" class="empty-state">
              <h3>Select a customer</h3>
              <p>Choose a customer from the sidebar to view their accounts</p>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <div class="footer">
      <div id="footerText">Select a customer to view accounts</div>
      <div class="pagination" id="pagination">
        <!-- Pagination will be inserted here -->
      </div>
    </div>
  </main>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Build accounts array directly from Django template loops
const accountsData = [
{% for customer in customers %}
  {% for account in customer.accounts.all %}
  {
    id: {{ account.id }},
    customer_id: {{ customer.id }},
    customer_name: "{{ customer.name|escapejs }}",
    name: "{{ account.name|escapejs }}",
    account_id: "{{ account.account_id|default:""|escapejs }}",
    region_name: "{{ account.region.name|default:""|escapejs }}",
    billing_cycle_name: "{{ account.billing_cycle.name|default:""|escapejs }}",
    billing_cycle_id: {{ account.billing_cycle.id|default:"null" }},
    currency: "{{ account.currency|default:"USD"|escapejs }}",
    active_po_number: "{{ account.active_purchase_order.po_number|default:""|escapejs }}",
    po_balance: "{{ account.po_balance|default:""|escapejs }}",
    last_billing_run: "{{ account.last_billing_run|date:"M d, Y"|default:""|escapejs }}",
    status: "{{ account.status|default:"unknown"|escapejs }}"
  }{% if not forloop.last or not forloop.parentloop.last %},{% endif %}
  {% endfor %}
{% endfor %}
];

let currentCustomerId = null;
let filteredAccounts = [];
let currentPage = 1;
const itemsPerPage = 10;

// Initialize with first customer if available
document.addEventListener('DOMContentLoaded', function() {
    const firstCustomer = document.querySelector('.brand.active');
    if (firstCustomer && accountsData.length > 0) {
        currentCustomerId = parseInt(firstCustomer.dataset.customerId);
        updateTitle(firstCustomer.dataset.customerName);
        applyFilters();
    } else {
        renderTable();
        updatePagination();
    }
});

function updateTitle(customerName) {
    document.getElementById('currentCustomerTitle').textContent = 
        `${customerName} ‚Äî End Customer Accounts`;
}

function formatMoney(amount, currency = 'USD') {
    if (!amount || amount === 'None' || amount === null || amount === undefined || amount === '') {
        return '‚Äî';
    }
    
    const currencySymbols = {
        'USD': '$', 'EUR': '‚Ç¨', 'GBP': '¬£', 'AUD': 'A$', 
        'INR': '‚Çπ', 'JPY': '¬•', 'CAD': 'C$'
    };
    
    const symbol = currencySymbols[currency] || currency + ' ';
    const numericAmount = parseFloat(amount);
    if (isNaN(numericAmount)) return '‚Äî';
    
    return symbol + numericAmount.toLocaleString(undefined, { 
        minimumFractionDigits: 2, 
        maximumFractionDigits: 2 
    });
}

function getStatusBadge(status) {
    const statusMap = {
        'active': { class: 'status active', text: 'Active' },
        'low_po_balance': { class: 'status low', text: 'Low Balance' },
        'missing_po': { class: 'status missing', text: 'Missing PO' },
        'inactive': { class: 'status inactive', text: 'Inactive' }
    };
    
    const statusInfo = statusMap[status] || { class: 'status', text: status || 'Unknown' };
    return `<span class="${statusInfo.class}">${statusInfo.text}</span>`;
}

function getPOChip(poNumber) {
    if (!poNumber || poNumber === 'None' || poNumber === null || poNumber === undefined || poNumber === '') {
        return '<span class="chip bad"><span>‚Ä¢</span>No Active PO</span>';
    }
    return `<span class="chip good"><span>‚Ä¢</span>${poNumber}</span>`;
}

function safeValue(value, defaultValue = '‚Äî') {
    return (value && value !== 'None' && value !== null && value !== undefined && value !== '') ? value : defaultValue;
}

// Customer sidebar handling
document.querySelectorAll('.brand').forEach(brand => {
    brand.addEventListener('click', function() {
        document.querySelectorAll('.brand').forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        
        currentCustomerId = parseInt(this.dataset.customerId);
        updateTitle(this.dataset.customerName);
        currentPage = 1;
        applyFilters();
    });
});

function applyFilters() {
   
    if (!currentCustomerId) {
        filteredAccounts = [];
        renderTable();
        updatePagination();
        return;
    }
    
    const searchTerm = (document.getElementById('accountSearch').value || '').toLowerCase().trim();
    const statusFilter = document.getElementById('statusFilter').value;
    const cycleFilter = document.getElementById('cycleFilter').value;
    
    filteredAccounts = accountsData.filter(account => {
        
        // Customer filter - ensure both are numbers for comparison
        if (parseInt(account.customer_id) !== parseInt(currentCustomerId)) {
            return false;
        }
        
        // Search filter
        if (searchTerm) {
            const searchableText = [
                account.name || '',
                account.account_id || ''
            ].join(' ').toLowerCase();
            
            if (!searchableText.includes(searchTerm)) return false;
        }
        
        // Status filter
        if (statusFilter && account.status !== statusFilter) return false;
        
        // Billing cycle filter
        if (cycleFilter && account.billing_cycle_id && 
            parseInt(account.billing_cycle_id) !== parseInt(cycleFilter)) return false;
        
        return true;
    });
    
    // Reset to first page if current page is beyond available pages
    const totalPages = Math.ceil(filteredAccounts.length / itemsPerPage) || 1;
    if (currentPage > totalPages) {
        currentPage = 1;
    }
    
    renderTable();
    updatePagination();
}

function renderTable() {
    const tbody = document.getElementById('accountsTableBody');
    const totalAccounts = filteredAccounts.length;
    
    document.getElementById('totalInfo').textContent = totalAccounts;
    
    if (totalAccounts === 0) {
        let emptyMessage, emptyDescription;
        
        if (!currentCustomerId) {
            emptyMessage = 'Select a customer';
            emptyDescription = 'Choose a customer from the sidebar to view their accounts';
        } else {
            emptyMessage = 'No accounts found';
            emptyDescription = 'Try adjusting your search or filters, or add a new account';
        }
        
        tbody.innerHTML = `
            <tr>
                <td colspan="10" class="empty-state">
                    <h3>${emptyMessage}</h3>
                    <p>${emptyDescription}</p>
                </td>
            </tr>
        `;
        
        document.getElementById('rangeInfo').textContent = '0‚Äî0';
        document.getElementById('footerText').textContent = 
            currentCustomerId ? 'No accounts to show' : 'Select a customer to view accounts';
        return;
    }
    
    const startIndex = (currentPage - 1) * itemsPerPage;
    const endIndex = Math.min(startIndex + itemsPerPage, totalAccounts);
    const pageAccounts = filteredAccounts.slice(startIndex, endIndex);
    
    document.getElementById('rangeInfo').textContent = `${startIndex + 1}‚Äî${endIndex}`;
    document.getElementById('footerText').textContent = 
        `Showing ${startIndex + 1} to ${endIndex} of ${totalAccounts} accounts`;
    
    tbody.innerHTML = pageAccounts.map(account => {
        const accountDetailUrl = "{% url 'customers:account_detail' pk=999999 %}".replace('999999', account.id);
        
        return `
            <tr>
                <td><input type="checkbox" value="${account.id}"></td>
                <td>
                    <div class="row-main">${safeValue(account.name, 'Unnamed Account')}</div>
                    <div class="row-sub">${safeValue(account.region_name)}</div>
                </td>
                <td class="mono">${safeValue(account.account_id)}</td>
                <td>${safeValue(account.billing_cycle_name)}</td>
                <td class="mono">${safeValue(account.currency, 'USD')}</td>
                <td>${getPOChip(account.active_po_number)}</td>
                <td>${formatMoney(account.po_balance, account.currency || 'USD')}</td>
                <td>${safeValue(account.last_billing_run)}</td>
                <td>${getStatusBadge(account.status)}</td>
                <td class="actions">
                    <a href="${accountDetailUrl}" title="View Account">üëÅ</a>
                    <button title="More Options">‚ãØ</button>
                </td>
            </tr>
        `;
    }).join('');
}

function updatePagination() {
    const totalPages = Math.ceil(filteredAccounts.length / itemsPerPage) || 1;
    const pagination = document.getElementById('pagination');
    
    if (filteredAccounts.length === 0) {
        pagination.innerHTML = '';
        return;
    }
    
    let paginationHTML = `
        <button ${currentPage === 1 ? 'disabled' : ''} onclick="changePage(${currentPage - 1})">
            Previous
        </button>
    `;
    
    const maxVisiblePages = 5;
    let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
    let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
    
    if (endPage - startPage + 1 < maxVisiblePages) {
        startPage = Math.max(1, endPage - maxVisiblePages + 1);
    }
    
    for (let i = startPage; i <= endPage; i++) {
        paginationHTML += `
            <button class="${i === currentPage ? 'current' : ''}" onclick="changePage(${i})">
                ${i}
            </button>
        `;
    }
    
    paginationHTML += `
        <button ${currentPage === totalPages ? 'disabled' : ''} onclick="changePage(${currentPage + 1})">
            Next
        </button>
    `;
    
    pagination.innerHTML = paginationHTML;
}

function changePage(page) {
    const totalPages = Math.ceil(filteredAccounts.length / itemsPerPage) || 1;
    if (page < 1 || page > totalPages) return;
    
    currentPage = page;
    renderTable();
    updatePagination();
}

// Event listeners
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('accountSearch').addEventListener('input', () => {
        currentPage = 1;
        applyFilters();
    });

    document.getElementById('statusFilter').addEventListener('change', () => {
        currentPage = 1;
        applyFilters();
    });

    document.getElementById('cycleFilter').addEventListener('change', () => {
        currentPage = 1;
        applyFilters();
    });

    document.getElementById('btnRefresh').addEventListener('click', () => {
        applyFilters();
    });

    document.getElementById('customerSearch').addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase();
        document.querySelectorAll('.brand').forEach(brand => {
            const customerName = (brand.dataset.customerName || '').toLowerCase();
            brand.style.display = customerName.includes(searchTerm) ? 'flex' : 'none';
        });
    });

    document.getElementById('selectAll').addEventListener('change', function() {
        const checkboxes = document.querySelectorAll('#accountsTableBody input[type="checkbox"]');
        checkboxes.forEach(cb => cb.checked = this.checked);
    });
});
</script>
{% endblock %}